<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa (Anonymous)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .container {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        select, input, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .admin {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        .hidden {
            display: none;
        }
        .success {
            color: green;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        .distribute-btn {
            background-color: #27ae60;
            margin-bottom: 20px;
        }
        .view-btn {
            background-color: #e67e22;
        }
        .anonymous {
            font-style: italic;
            color: #777;
        }
        .password-view {
            margin-top: 40px;
            padding: 20px;
            background-color: #e8f4fc;
            border-radius: 8px;
        }
        .phase-indicator {
            margin: 15px 0;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Secret Santa</h1>
        
        <div id="phaseIndicator" class="phase-indicator"></div>
        
        <div id="userForm">
            <div class="form-group">
                <label>Select Your Name:</label>
                <select id="userName" required>
                    <option value="">-- Select your name --</option>
                    <!-- Names will be loaded from storage -->
                </select>
            </div>
            
            <div class="form-group">
                <label>Create Your Password (For check result):</label>
                <input type="password" id="userPassword" required placeholder="Create your secret password">
            </div>
            
            <div class="form-group">
                <label>Keyword of your gift:</label>
                <input type="text" id="userValue" required placeholder="">
            </div>
            
            <button onclick="submitForm()">Submit</button>
            <p id="successMessage" class="hidden success">Submitted successfully!</p>
        </div>
        
        <div id="adminSection" class="admin hidden">
            <h2>Admin View</h2>
            <button onclick="showAdminData()">View All Submissions</button>
            <button onclick="distributeValues()" class="distribute-btn">🎄 Distribute Gifts Randomly 🎄</button>
            <div id="adminData"></div>
            <div id="distributionResults" class="hidden"></div>
        </div>
        
        <div id="passwordSection" class="password-view hidden">
            <h2>View Your Assignment</h2>
            <div class="form-group">
                <label>Enter Your Password:</label>
                <input type="password" id="viewerPassword" required placeholder="Your secret password">
            </div>
            <button onclick="viewAssignment()" class="view-btn">View My Gift</button>
            <div id="assignmentResult" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        // Store all submissions (without linking names to gifts)
        let submissions = JSON.parse(localStorage.getItem('anonymousSubmissions')) || [];
        // Store passwords separately (name -> password)
        let passwordDatabase = JSON.parse(localStorage.getItem('passwordDatabase')) || {};
        // Store the list of names
        let nameList = JSON.parse(localStorage.getItem('nameList')) || 
                      ['Connie', 'Sharon', 'Wilson', 'Miu', 'ChuSum', 'LCH', 'Adrian', 'KA', 'Chick', 'Nataile', 'TMH', '會長', 'Ken', 'Pete'];
        // Store distribution results
        let distributionResults = JSON.parse(localStorage.getItem('distributionResults')) || null;
        
        // Initialize the name dropdown
        function initNameList() {
            const select = document.getElementById('userName');
            // Clear existing options except the first one
            while (select.options.length > 1) {
                select.remove(1);
            }
            // Add names from nameList
            nameList.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }
        
        // Update phase indicator
        function updatePhaseIndicator() {
            const indicator = document.getElementById('phaseIndicator');
            if (distributionResults && Object.keys(distributionResults).length > 0) {
                indicator.innerHTML = '🎅 DISTRIBUTION PHASE: Enter your password to view your assigned gift';
            } else if (submissions.length > 0) {
                indicator.innerHTML = '✏️ SUBMISSION PHASE: Please submit your gift suggestion';
            } else {
                indicator.innerHTML = '✨ WELCOME: Please submit your gift suggestion';
            }
        }
        
        // Submit form
        function submitForm() {
            const name = document.getElementById('userName').value;
            const password = document.getElementById('userPassword').value.trim();
            const value = document.getElementById('userValue').value.trim();
            
            if (!name || !password || !value) {
                alert('Please fill all fields!');
                return;
            }
            
            // Check if password already exists
            if (passwordDatabase[name] && passwordDatabase[name] !== password) {
                alert('This name already has a different password!');
                return;
            }
            
            // Store password (name -> password mapping)
            passwordDatabase[name] = password;
            localStorage.setItem('passwordDatabase', JSON.stringify(passwordDatabase));
            
            // Add to submissions (without linking name to gift)
            const submissionId = 'sub_' + Math.random().toString(36).substr(2, 9);
            submissions.push({
                id: submissionId,
                value: value,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('anonymousSubmissions', JSON.stringify(submissions));
            
            // Show success
            document.getElementById('successMessage').classList.remove('hidden');
            
            // Clear form (keep name selected)
            document.getElementById('userPassword').value = '';
            document.getElementById('userValue').value = '';
            
            // Hide success after 3 seconds
            setTimeout(() => {
                document.getElementById('successMessage').classList.add('hidden');
            }, 3000);
            
            // Update view
            checkAdmin();
            updatePhaseIndicator();
        }
        
        // Admin functions
        function checkAdmin() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === 'true') {
                document.getElementById('adminSection').classList.remove('hidden');
                document.getElementById('passwordSection').classList.add('hidden');
                document.getElementById('userForm').classList.add('hidden');
            } else {
                if (distributionResults && Object.keys(distributionResults).length > 0) {
                    // Distribution phase
                    document.getElementById('passwordSection').classList.remove('hidden');
                    document.getElementById('userForm').classList.add('hidden');
                } else {
                    // Submission phase
                    document.getElementById('userForm').classList.remove('hidden');
                    document.getElementById('passwordSection').classList.add('hidden');
                }
            }
        }
        
        function showAdminData() {
            const adminData = document.getElementById('adminData');
            adminData.innerHTML = '<h3>All Submissions (Anonymous View):</h3>';
            
            if (submissions.length === 0) {
                adminData.innerHTML += '<p>No submissions yet.</p>';
                return;
            }
            
            // Create a table showing anonymous submissions
            adminData.innerHTML += `
                <table>
                    <tr>
                        <th>No.</th>
                        <th>Gift Suggestion</th>
                        <th>Time Submitted</th>
                    </tr>
                    ${submissions.map((sub, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${sub.value}</td>
                            <td>${new Date(sub.timestamp).toLocaleTimeString()}</td>
                        </tr>
                    `).join('')}
                </table>
                <p class="anonymous">Note: Submissions are anonymous - admin cannot see who submitted what</p>
            `;
        }
        
        // Randomly distribute values to names
        function distributeValues() {
            if (submissions.length === 0) {
                alert('No submissions to distribute!');
                return;
            }
            
            if (nameList.length === 0) {
                alert('No names in the list!');
                return;
            }
            
            // Shuffle the gifts
            const shuffledGifts = [...submissions].sort(() => 0.5 - Math.random()).map(s => s.value);
            
            // Shuffle the recipients
            const shuffledRecipients = [...nameList].sort(() => 0.5 - Math.random());
            
            // Create distribution (each recipient gets one random gift)
            distributionResults = {};
            shuffledRecipients.forEach((recipient, index) => {
                if (index < shuffledGifts.length) {
                    distributionResults[recipient] = {
                        gift: shuffledGifts[index],
                        password: passwordDatabase[recipient] || 'not_set'
                    };
                }
            });
            
            // Save distribution results
            localStorage.setItem('distributionResults', JSON.stringify(distributionResults));
            
            // Update views
            checkAdmin();
            updatePhaseIndicator();
            
            // Display results (admin only sees recipient + gift, not who submitted it)
            const resultsDiv = document.getElementById('distributionResults');
            resultsDiv.innerHTML = '<h3>🎅 Secret Santa Assignments 🎅</h3>';
            
            if (Object.keys(distributionResults).length === 0) {
                resultsDiv.innerHTML += '<p>No valid distributions made!</p>';
            } else {
                resultsDiv.innerHTML += `
                    <table>
                        <tr>
                            <th>Recipient</th>
                            <th>Assigned Gift</th>
                        </tr>
                        ${Object.entries(distributionResults).map(([recipient, data]) => `
                            <tr>
                                <td>${recipient}</td>
                                <td>${data.gift}</td>
                            </tr>
                        `).join('')}
                    </table>
                    <div style="margin-top: 20px; background: #fff3cd; padding: 15px; border-radius: 4px;">
                        <h4>Instructions</h4>
                        <p>Participants can view their assigned gift by entering their password on the main page.</p>
                        <p><strong>Admin cannot see who submitted which gift.</strong></p>
                    </div>
                `;
            }
            
            resultsDiv.classList.remove('hidden');
        }
        
        // View assignment with password
        function viewAssignment() {
            const password = document.getElementById('viewerPassword').value.trim();
            
            if (!password) {
                alert('Please enter your password!');
                return;
            }
            
            // Find which name this password belongs to
            const name = Object.keys(passwordDatabase).find(
                name => passwordDatabase[name] === password
            );
            
            const resultDiv = document.getElementById('assignmentResult');
            
            if (name && distributionResults[name]) {
                resultDiv.innerHTML = `
                    <div style="background: #e8f4fc; padding: 15px; border-radius: 4px;">
                        <h3>Hello ${name}!</h3>
                        <p>Your assigned gift is: <strong>${distributionResults[name].gift}</strong></p>
                        <p style="font-style: italic;">Happy gifting! 🎁</p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 4px; color: #721c24;">
                        Invalid password or no assignment found. Please check your password and try again.
                    </div>
                `;
            }
        }
        
        // Initialize on load
        window.onload = function() {
            initNameList();
            
            // Load existing data
            const loadedSubmissions = JSON.parse(localStorage.getItem('anonymousSubmissions'));
            if (loadedSubmissions) submissions = loadedSubmissions;
            
            const loadedPasswords = JSON.parse(localStorage.getItem('passwordDatabase'));
            if (loadedPasswords) passwordDatabase = loadedPasswords;
            
            const loadedDistribution = JSON.parse(localStorage.getItem('distributionResults'));
            if (loadedDistribution) distributionResults = loadedDistribution;
            
            checkAdmin();
            updatePhaseIndicator();
        };
    </script>
</body>
</html>