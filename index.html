<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa (Name + Password)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .container {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        select, input, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .admin {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        .hidden {
            display: none;
        }
        .success {
            color: green;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        .distribute-btn {
            background-color: #27ae60;
            margin-bottom: 20px;
        }
        .view-btn {
            background-color: #e67e22;
        }
        .reset-btn {
            background-color: #e74c3c;
            margin-top: 20px;
        }
        .anonymous {
            font-style: italic;
            color: #777;
        }
        .password-view {
            margin-top: 40px;
            padding: 20px;
            background-color: #e8f4fc;
            border-radius: 8px;
        }
        .phase-indicator {
            margin: 15px 0;
            padding: 10px;
            background-color: #fff3cd;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
        .status-info {
            margin: 15px 0;
            padding: 10px;
            background-color: #e8f4fc;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Secret Santa</h1>
        
        <div id="phaseIndicator" class="phase-indicator"></div>
        
        <div id="userForm">
            <div class="form-group">
                <label>你個名:</label>
                <select id="userName" required>
                    <option value="">-- Select your name --</option>
                    <!-- Names will be loaded from storage -->
                </select>
            </div>
            
            <div class="form-group">
                <label>密碼 (自己記往! Admin唔會知你咩密碼):</label>
                <input type="password" id="userPassword" required placeholder="Secret password">
            </div>
            
            <div class="form-group">
                <label>關鍵字:</label>
                <input type="text" id="userValue" required placeholder="">
            </div>
            
            <button onclick="submitForm()">Submit</button>
            <p id="successMessage" class="hidden success">Submitted successfully!</p>
        </div>
        
        <div id="adminSection" class="admin hidden">
            <h2>Admin View</h2>
            <div class="status-info">
                <p><strong>${nameList.length}</strong> participants in list</p>
                <p><strong>${Object.keys(credentialsDB).length}</strong> have created accounts</p>
                <p><strong>${submissions.length}</strong> gift suggestions submitted</p>
            </div>
            <button onclick="showAdminData()">View All Submissions</button>
            <button onclick="distributeValues()" class="distribute-btn">🎄 Distribute Gifts Randomly 🎄</button>
            <button onclick="resetDistribution()" class="reset-btn">🔄 Reset to Submission Phase</button>
            <div id="adminData"></div>
        </div>
        
        <div id="passwordSection" class="password-view hidden">
            <h2>睇下要送啲咩</h2>
            <div class="form-group">
                <label>你個名:</label>
                <select id="viewerName" required>
                    <option value="">-- Select your name --</option>
                    <!-- Names will be loaded from storage -->
                </select>
            </div>
            <div class="form-group">
                <label>密碼:</label>
                <input type="password" id="viewerPassword" required placeholder="Your secret password">
            </div>
            <button onclick="viewAssignment()" class="view-btn">Submit</button>
            <div id="assignmentResult" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        // Store all submissions (anonymous)
        let submissions = JSON.parse(localStorage.getItem('anonymousSubmissions')) || [];
        // Store name+password combinations
        let credentialsDB = JSON.parse(localStorage.getItem('credentialsDB')) || {};
        // Store the list of names
        let nameList = JSON.parse(localStorage.getItem('nameList')) || 
                      ['Connie', 'Sharon', 'Wilson', 'Miu', 'ChuSum', 'LCH', 'Adrian', 'KA', 'Chick', 'Nataile', 'TMH', '會長', 'Ken', 'Pete'];
        // Store distribution results
        let distributionResults = JSON.parse(localStorage.getItem('distributionResults')) || null;
        
        // Initialize name dropdowns
        function initNameLists() {
            const submitSelect = document.getElementById('userName');
            const viewSelect = document.getElementById('viewerName');
            
            // Clear existing options except the first one
            while (submitSelect.options.length > 1) submitSelect.remove(1);
            while (viewSelect.options.length > 1) viewSelect.remove(1);
            
            // Add names from nameList
            nameList.forEach(name => {
                const option1 = document.createElement('option');
                option1.value = name;
                option1.textContent = name;
                submitSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = name;
                option2.textContent = name;
                viewSelect.appendChild(option2);
            });
        }
        
        // Update phase indicator
        function updatePhaseIndicator() {
            const indicator = document.getElementById('phaseIndicator');
            if (distributionResults && Object.keys(distributionResults).length > 0) {
                indicator.innerHTML = '🎅 揀翻你個名同入翻密碼就可以知道你要送咩比人 !';
            } else if (submissions.length > 0) {
                indicator.innerHTML = '✏️ 你想收到禮物嘅關鍵字';
            } else {
                indicator.innerHTML = '✨ 你想收到禮物嘅關鍵字';
            }
            
            // Update status info in admin panel
            if (document.getElementById('adminSection') && !document.getElementById('adminSection').classList.contains('hidden')) {
                const statusInfo = document.querySelector('.status-info');
                if (statusInfo) {
                    statusInfo.innerHTML = `
                        <p><strong>${nameList.length}</strong> participants in list</p>
                        <p><strong>${Object.keys(credentialsDB).length}</strong> have created accounts</p>
                        <p><strong>${submissions.length}</strong> gift suggestions submitted</p>
                    `;
                }
            }
        }
        
        // Submit form
        function submitForm() {
            const name = document.getElementById('userName').value;
            const password = document.getElementById('userPassword').value.trim();
            const value = document.getElementById('userValue').value.trim();
            
            if (!name || !password || !value) {
                alert('Please fill all fields!');
                return;
            }
            
            // Store credentials (name -> password)
            credentialsDB[name] = password;
            localStorage.setItem('credentialsDB', JSON.stringify(credentialsDB));
            
            // Check if this user already submitted (prevent duplicates)
            const existingIndex = submissions.findIndex(sub => sub.user === name);
            if (existingIndex >= 0) {
                submissions[existingIndex] = {
                    id: submissions[existingIndex].id,
                    user: name,
                    value: value,
                    timestamp: new Date().toISOString()
                };
            } else {
                // Add to submissions (store user reference but admin can't see it)
                const submissionId = 'sub_' + Math.random().toString(36).substr(2, 9);
                submissions.push({
                    id: submissionId,
                    user: name,  // Store user reference but admin won't see this
                    value: value,
                    timestamp: new Date().toISOString()
                });
            }
            
            localStorage.setItem('anonymousSubmissions', JSON.stringify(submissions));
            
            // Show success
            document.getElementById('successMessage').classList.remove('hidden');
            
            // Clear form (keep name selected)
            document.getElementById('userPassword').value = '';
            document.getElementById('userValue').value = '';
            
            // Hide success after 3 seconds
            setTimeout(() => {
                document.getElementById('successMessage').classList.add('hidden');
            }, 3000);
            
            // Update view
            checkAdmin();
            updatePhaseIndicator();
        }
        
        // Admin functions
        function checkAdmin() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === 'true') {
                document.getElementById('adminSection').classList.remove('hidden');
                document.getElementById('passwordSection').classList.add('hidden');
                document.getElementById('userForm').classList.add('hidden');
            } else {
                if (distributionResults && Object.keys(distributionResults).length > 0) {
                    // Distribution phase
                    document.getElementById('passwordSection').classList.remove('hidden');
                    document.getElementById('userForm').classList.add('hidden');
                } else {
                    // Submission phase
                    document.getElementById('userForm').classList.remove('hidden');
                    document.getElementById('passwordSection').classList.add('hidden');
                }
            }
            
            updatePhaseIndicator();
        }
        
        function showAdminData() {
            const adminData = document.getElementById('adminData');
            adminData.innerHTML = '<h3>All Submissions (Anonymous View):</h3>';
            
            if (submissions.length === 0) {
                adminData.innerHTML += '<p>No submissions yet.</p>';
                return;
            }
            
            // Create a table showing anonymous submissions (without user info)
            adminData.innerHTML += `
                <table>
                    <tr>
                        <th>No.</th>
                        <th>Gift Suggestion</th>
                        <th>Time Submitted</th>
                    </tr>
                    ${submissions.map((sub, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${sub.value}</td>
                            <td>${new Date(sub.timestamp).toLocaleTimeString()}</td>
                        </tr>
                    `).join('')}
                </table>
                <p class="anonymous">Note: Submissions are anonymous - admin cannot see who submitted what</p>
            `;
        }
        
        // Randomly distribute values to names
        function distributeValues() {
            if (submissions.length === 0) {
                alert('No submissions to distribute!');
                return;
            }
            
            // Get list of users who have both:
            // 1. Created an account (name + password)
            // 2. Submitted a gift suggestion
            const eligibleUsers = [];
            nameList.forEach(name => {
                // Check if user has an account
                const hasAccount = credentialsDB.hasOwnProperty(name);
                // Check if user has submitted a gift
                const hasSubmitted = submissions.some(sub => sub.user === name);
                
                if (hasAccount && hasSubmitted) {
                    eligibleUsers.push(name);
                }
            });
            
            if (eligibleUsers.length === 0) {
                alert('No eligible participants found! Participants must:\n1. Create an account\n2. Submit a gift suggestion');
                return;
            }
            
            if (eligibleUsers.length === 1) {
                alert('Need at least 2 eligible participants to distribute gifts!');
                return;
            }
            
            // Shuffle the eligible users
            const shuffledUsers = [...eligibleUsers].sort(() => 0.5 - Math.random());
            
            // Create distribution (each user gets another user's gift)
            distributionResults = {};
            
            // Create a circular assignment
            for (let i = 0; i < shuffledUsers.length; i++) {
                const giver = shuffledUsers[i];
                const receiver = shuffledUsers[(i + 1) % shuffledUsers.length];
                
                // Find the receiver's gift submission
                const receiverSubmission = submissions.find(sub => sub.user === receiver);
                if (receiverSubmission) {
                    distributionResults[giver] = receiverSubmission.value;
                }
            }
            
            // Save distribution results
            localStorage.setItem('distributionResults', JSON.stringify(distributionResults));
            
            // Update views
            checkAdmin();
            updatePhaseIndicator();
            
            // Show success message to admin
            const adminData = document.getElementById('adminData');
            adminData.innerHTML = `
                <div style="background: #d4edda; padding: 15px; border-radius: 4px; color: #155724; margin-top: 20px;">
                    <h3>🎅 Distribution Successful!</h3>
                    <p>Gifts have been distributed to <strong>${eligibleUsers.length}</strong> eligible participants.</p>
                    <p>Participants can now view their assigned gifts by entering their name and password.</p>
                </div>
            `;
        }
        
        // Reset distribution and go back to submission phase
        function resetDistribution() {
            if (confirm('Are you sure you want to reset the distribution?\n\nThis will:' + 
                       '\n- Clear all gift assignments' + 
                       '\n- Allow participants to submit new gift suggestions' +
                       '\n\nExisting accounts and submissions will remain.')) {
                // Clear distribution results
                distributionResults = null;
                localStorage.removeItem('distributionResults');
                
                // Update views
                checkAdmin();
                updatePhaseIndicator();
                
                // Clear the admin data display
                document.getElementById('adminData').innerHTML = '';
            }
        }
        
        // View assignment with name + password
        function viewAssignment() {
            const name = document.getElementById('viewerName').value;
            const password = document.getElementById('viewerPassword').value.trim();
            
            if (!name || !password) {
                alert('Please enter both name and password!');
                return;
            }
            
            const resultDiv = document.getElementById('assignmentResult');
            
            // Verify credentials
            if (credentialsDB[name] !== password) {
                resultDiv.innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 4px; color: #721c24;">
                        Invalid name/password combination. Please try again.
                    </div>
                `;
                return;
            }
            
            // Check if assignment exists
            if (distributionResults && distributionResults[name]) {
                resultDiv.innerHTML = `
                    <div style="background: #e8f4fc; padding: 15px; border-radius: 4px;">
                        <h3>Hi ${name}! 🎅</h3>
                        <p>你要買個份禮物嘅keyword係 <strong>${distributionResults[name]}</strong></p>
                        <p style="font-style: italic;">🎄 Merry Christmas! 🎁</p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 4px; color: #856404;">
                        No assignment found for ${name}. Please contact the organizer.
                    </div>
                `;
            }
        }
        
        // Initialize on load
        window.onload = function() {
            initNameLists();
            
            // Load existing data
            const loadedSubmissions = JSON.parse(localStorage.getItem('anonymousSubmissions'));
            if (loadedSubmissions) submissions = loadedSubmissions;
            
            const loadedCredentials = JSON.parse(localStorage.getItem('credentialsDB'));
            if (loadedCredentials) credentialsDB = loadedCredentials;
            
            const loadedDistribution = JSON.parse(localStorage.getItem('distributionResults'));
            if (loadedDistribution) distributionResults = loadedDistribution;
            
            checkAdmin();
            updatePhaseIndicator();
        };
    </script>
</body>
</html>